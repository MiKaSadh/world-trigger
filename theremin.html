<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Controller Theremin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: black; color: white; text-align: center; font-size: 20px; }
    </style>
</head>
<body>
    <h2>Proã‚³ãƒ³ã‚’æ¥ç¶šã—ã¦æ“ä½œã—ã¦ãã ã•ã„</h2>
    <script>
        let oscs = [];
        let filter, reverb;
        let targetFreqs = [], currentFreqs = [];
        let targetVolume = 0.5, currentVolume = 0.5;
        let isStarted = false;
        let isMinor = false;
        let gamepadIndex = null;

        const majorChords = [[261.63, 329.63, 392.00], [293.66, 349.23, 440.00], [329.63, 392.00, 493.88]];
        const minorChords = [[261.63, 311.13, 392.00], [293.66, 349.23, 415.30], [329.63, 392.00, 466.16]];

        function setup() {
            createCanvas(windowWidth, windowHeight);
            textAlign(CENTER, CENTER);

            filter = new p5.Filter('lowpass');
            reverb = new p5.Reverb();

            for (let i = 0; i < 3; i++) {
                let osc = new p5.Oscillator('sine');
                osc.disconnect();
                osc.connect(filter);
                reverb.process(osc, 3, 2);
                oscs.push(osc);
                targetFreqs.push(261.63);
                currentFreqs.push(261.63);
            }

            setInterval(updateGamepad, 50); // 50msã”ã¨ã«ã‚²ãƒ¼ãƒ ãƒ‘ãƒƒãƒ‰ã®å…¥åŠ›ã‚’ãƒã‚§ãƒƒã‚¯
        }

        function startAudio() {
            console.log("Audio Started!");
            userStartAudio().then(() => {
                if (!isStarted) {
                    for (let osc of oscs) {
                        osc.start();
                        osc.amp(0.5, 0.1); // æœ€åˆã®éŸ³é‡ã‚’0.5ã«ã‚»ãƒƒãƒˆï¼ˆéŸ³ãŒã™ãæ¶ˆãˆãªã„ã‚ˆã†ã«ï¼‰
                    }
                    isStarted = true;
                }
            });
        }

        function updateGamepad() {
            let gamepads = navigator.getGamepads();
            if (!gamepads) return;
            
            let gp = null;
            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) {
                    gp = gamepads[i];
                    gamepadIndex = i;
                    break;
                }
            }
            if (!gp) return;

            // ğŸ® å·¦ã‚¹ãƒ†ã‚£ãƒƒã‚¯ä¸Šä¸‹ï¼šãƒ”ãƒƒãƒå¤‰æ›´
            let pitchControl = gp.axes[1]; 
            if (!isNaN(pitchControl)) {
                let chordIndex = floor(map(pitchControl, -1, 1, 0, majorChords.length));
                chordIndex = constrain(chordIndex, 0, majorChords.length - 1);
                let selectedChords = isMinor ? minorChords : majorChords;
                let chord = selectedChords[chordIndex];

                for (let i = 0; i < 3; i++) {
                    targetFreqs[i] = chord[i];
                }
            }

            // ğŸ® å³ã‚¹ãƒ†ã‚£ãƒƒã‚¯ä¸Šä¸‹ï¼šéŸ³é‡å¤‰æ›´
            let volumeControl = gp.axes[3];
            if (!isNaN(volumeControl)) {
                targetVolume = constrain(map(volumeControl, -1, 1, 0, 1), 0.1, 1);
            }

            // ğŸ® Xãƒœã‚¿ãƒ³ã§ãƒã‚¤ãƒŠãƒ¼ã‚³ãƒ¼ãƒ‰ã€Yãƒœã‚¿ãƒ³ã§ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚³ãƒ¼ãƒ‰
            if (gp.buttons[2].pressed) { isMinor = true; }
            if (gp.buttons[3].pressed) { isMinor = false; }

            // ğŸ® ZLã§ãƒªãƒãƒ¼ãƒ–ON/OFF
            if (gp.buttons[6].pressed) {
                reverb.process(filter, 5, 2);
            } else {
                reverb.process(filter, 0, 0);
            }

            // ğŸ® ZRã§ãƒ“ãƒ–ãƒ©ãƒ¼ãƒˆON/OFF
            if (gp.buttons[7].pressed) {
                for (let i = 0; i < oscs.length; i++) {
                    oscs[i].freq(targetFreqs[i] + sin(frameCount * 0.1) * 5);
                }
            }
        }

        function draw() {
            background(0);
            fill(255);
            textSize(24);
            text(`Pitch: ${Math.round(targetFreqs[0])} Hz`, width / 2, height / 4);
            text(`Volume: ${targetVolume.toFixed(2)}`, width / 2, height / 3);
            text(isMinor ? "ã‚³ãƒ¼ãƒ‰: ãƒã‚¤ãƒŠãƒ¼" : "ã‚³ãƒ¼ãƒ‰: ãƒ¡ã‚¸ãƒ£ãƒ¼", width / 2, height / 2);
            text(`Press A to Start Audio`, width / 2, height * 0.8);

            if (gamepadIndex !== null) {
                text(`Gamepad Connected: ${navigator.getGamepads()[gamepadIndex].id}`, width / 2, height - 40);
            }

            // ğŸµ éŸ³ã®æ›´æ–°
            for (let i = 0; i < oscs.length; i++) {
                currentFreqs[i] = lerp(currentFreqs[i], targetFreqs[i], 0.1);
                oscs[i].freq(currentFreqs[i]);
                oscs[i].amp(targetVolume, 0.1); // éŸ³é‡ãŒ0ã«ãªã‚‰ãªã„ã‚ˆã†ã‚¹ãƒ ãƒ¼ã‚ºã«å¤‰åŒ–
            }
        }

        function keyPressed() {
            if (key === 'A' || key === 'a') {
                startAudio();
            }
        }
    </script>
</body>
</html>
